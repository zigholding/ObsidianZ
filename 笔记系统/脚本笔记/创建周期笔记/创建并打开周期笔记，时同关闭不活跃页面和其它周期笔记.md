---
PrevNote: "[[åˆ›å»ºå‘¨æœŸç¬”è®°]]"
NextNote: "[[æ‰“å¼€æ¯æ—¥ç¬”è®°]]"
notechain:
  level: "\t"
words:
  2025-05-29: 419
  2025-06-11: 459
tags:
  - Publish/ObsidianZ
emoji: ğŸ“£
---


```js //templater
// [] å†…çš„ä¸æ ¼å¼åŒ–
let path_fmt = tp.config.extra?.path_fmt;
let md_template = tp.config.extra?.md_template;
let t  = tp.config?.extra.t;
if(!path_fmt || !md_template || !t){
	return
}
let nc = app.plugins.getPlugin('note-chain');
async function create_daily(t=new moment(),open=true,time_out=12*60){
	let path = t.format(path_fmt)
	let note = tp.file.find_tfile(path);
	if(!note){ //ã€€ä¸å­˜åœ¨æ—¶åˆ›å»ºç¬”è®°
		let folder_path = path.split('/')
		folder_path = folder_path.slice(0,folder_path.length-1).join('/')
		let folder = app.vault.getFolderByPath(folder_path)
		if(!folder){
			folder = await app.vault.createFolder(folder_path)
		}
		let tmp = tp.file.find_tfile(md_template);
		// tp åˆ›å»ºç¬”è®°æ—¶ï¼Œæ–‡ä»¶åä¸å¸¦åç¼€
		let name = path.split('/').last()
		name = name.slice(0,name.length-3)
		note = await tp.file.create_new(tmp,name,false,folder);
	}
	
	if(note && open){
		await nc.utils.parse_templater(app,'å…³é—­é‡å¤æ ‡ç­¾',true,null);
		await nc.utils.parse_templater(app,'å…³é—­é•¿æ—¶é—´ä¸æ´»è·ƒæ ‡ç­¾',true,null);
		await nc.utils.parse_templater(app,'Files - åˆ é™¤syncthingåŒæ­¥äº§ç”Ÿçš„å†²çªæ–‡ä»¶',true,null);

		
		// å…³é—­æ‰€æœ‰ç©ºé¡µé¢
		await app.workspace.detachLeavesOfType('empty');
		
		let leaves = app.workspace.getLeavesOfType('markdown');
		// ç©ºé¡µé¢æ—¶æ‰“å¼€æ–°æ ‡ç­¾
		if(leaves.length==0){
			let leaf = await app.workspace.getLeaf();
            await leaf.openFile(note);
            await leaf.setPinned(true);
            await app.workspace.setActiveLeaf(leaf);
			await app.workspace.detachLeavesOfType('empty');
			return;
		}
		
		
		// æ˜¯å¦ç»§ç»­æ£€æµ‹
		let is_continue = true;
		
		// æ˜¯å¦å·²ç»æ‰“å¼€äº†å½“å‰æ—¥å¿—ï¼Ÿ
		// å¦‚æœæ˜¯ï¼Œå½“å‰æ ‡ç­¾å·²æœ‰ï¼Œæ‰“å¼€ç¬¬ä¸€ä¸ª
		for(let leaf of leaves){
			if(leaf.view.file?.path==note.path){
				leaf.setPinned(true);
				app.workspace.setActiveLeaf(leaf);
				is_continue = false;
				break;
			}
		}
		
		// å·²æ‰“å¼€çš„æ ‡ç­¾ä¸­ï¼Œæ²¡æœ‰å½“æ—¥æ—¥å¿—
		for(let leaf of leaves){
			if(is_continue){
				if(leaf.view.file?.parent==note.parent){
					await leaf.openFile(note);
					leaf.setPinned(true);
					app.workspace.setActiveLeaf(leaf);
					is_continue = false;
					break;
				}
				
				if(leaf.getViewState().pinned){
					continue;
				}else{
					await leaf.openFile(note);
					await leaf.setPinned(true);
					await app.workspace.setActiveLeaf(leaf);
					is_continue = false;
					break;
				}
			}
		}
		if(is_continue){
			// æ‰€æœ‰é¡µé¢éƒ½æ˜¯é”å®š
			let leaf = app.workspace.getLeaf();
			await leaf.openFile(note);
			await leaf.setPinned(true);
			await app.workspace.setActiveLeaf(leaf);
		}
		
		// å…³é—­å…¶å®ƒæ—¥å¿—ç¬”è®°
		leaves = app.workspace.getLeavesOfType('markdown');
		for(let leaf of leaves){
			let cfile = leaf.view.file;
			if(!cfile || cfile==note){
				continue;
			}else if(cfile?.parent==note.parent){
				await leaf.detach()
			}
		}
	}
}
await create_daily(t);
```
